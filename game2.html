<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climb The Hill - Multiplayer Quiz</title>
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc, query, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDh2B68G_kRSGk22Mko8HU3ztPKNgY1EEE",
      authDomain: "cpe-buddy.firebaseapp.com",
      projectId: "cpe-buddy",
      storageBucket: "cpe-buddy.appspot.com",
      messagingSenderId: "171132740113",
      appId: "1:171132740113:web:861b870b8f900429fcc7b0",
      measurementId: "G-PVQTEF4HHZ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Globals ---
    let playerName = "";
    let gameCode = "";
    let localPlayerId = "";
    let gameRoomUnsub = null;
    let chatUnsub = null;
    let lobbyChatUnsub = null;
    let gameRoomData = null;
    let barMax = 20;
    let timerInterval = null;
    let endTime = 0;
    let gameEnded = false;
    let playAgainClicked = false;
    let leaderboard = {};
    let lastBarSnapshot = {};
    let kickedFlag = false;
    let joinLock = false; // prevent join spam

    // --- Utility ---
    function randomCode() {
      return Math.random().toString(36).substring(2,8).toUpperCase();
    }
    function chooseQuestions(arr, n) {
      if (arr.length <= n) return arr;
      const shuffled = arr.slice().sort(() => Math.random() - 0.5);
      return shuffled.slice(0, n);
    }
    function show(pageId) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById(pageId).style.display = 'flex';
    }
    window.show = show; // for inline HTML onclick

    // --- Main Menu ---
    window.gotoMultiplayer = function() {
      show('multiLobby');
      document.getElementById('mpError').innerText = "";
    };
    window.onload = function() {
      show('mainMenu');
    };

    // --- Lobby Chat ---
    function setupLobbyChat(code) {
      const chatZone = document.getElementById('lobbyChatDisplay');
      chatZone.innerHTML = "";
      const chatCol = collection(db, `climb_lobby_chat_${code}`);
      const chatQ = query(chatCol, orderBy("ts"));
      if (lobbyChatUnsub) lobbyChatUnsub();
      lobbyChatUnsub = onSnapshot(chatQ, snap => {
        let arr = [];
        snap.forEach(doc => arr.push(doc.data()));
        chatZone.innerHTML = arr.map(msg => `<div class="chat-msg"><b>${msg.name}</b>: ${msg.text}</div>`).join('');
        chatZone.scrollTop = chatZone.scrollHeight;
      });
    }
    window.sendLobbyChatMsg = async function() {
      let msg = document.getElementById('lobbyChatInput').value.trim();
      if (!msg) return;
      const chatCol = collection(db, `climb_lobby_chat_${gameCode}`);
      await addDoc(chatCol, {
        name: playerName,
        text: msg,
        ts: Date.now()
      });
      document.getElementById('lobbyChatInput').value = "";
    };

    // --- Create Game Room ---
    window.createGameRoom = async function() {
      playerName = document.getElementById('mpName').value.trim();
      if (!playerName) {
        document.getElementById('mpError').innerText = "Enter your name!";
        return;
      }
      gameCode = randomCode();
      localPlayerId = randomCode() + Date.now();
      const colRef = collection(db, "computersystem_questions");
      const snapshot = await getDocs(colRef);
      let questions = [];
      snapshot.forEach(docSnap => {
        const q = docSnap.data();
        questions.push(q);
      });
      questions = chooseQuestions(questions, 30);
      endTime = Date.now() + 5 * 60 * 1000;
      let leaderboardInit = {};
      leaderboardInit[localPlayerId] = 0;
      await setDoc(doc(db, "climb_games", gameCode), {
        code: gameCode,
        host: localPlayerId,
        started: false,
        questions,
        barMax,
        endTime,
        winner: null,
        playAgain: [],
        leaderboard: leaderboardInit,
        players: {
          [localPlayerId]: {
            name: playerName,
            bar: 0,
            wrongStreak: 0,
            mpQIndex: 0,
            finished: false,
            score: 0
          }
        }
      });
      joinGameRoom(gameCode, localPlayerId, true);
    };

    // --- Join Game Room: Prevent join spam, only 1 join allowed per user ---
    window.joinGameRoomBtn = async function() {
      if (joinLock) return;
      joinLock = true;
      try {
        playerName = document.getElementById('mpName').value.trim();
        if (!playerName) {
          document.getElementById('mpError').innerText = "Enter your name!";
          joinLock = false; return;
        }
        const code = document.getElementById('mpCode').value.trim().toUpperCase();
        if (!code) {
          document.getElementById('mpError').innerText = "Enter code!";
          joinLock = false; return;
        }
        const roomRef = doc(db, "climb_games", code);
        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) {
          document.getElementById('mpError').innerText = "Room not found!";
          joinLock = false; return;
        }
        let data = roomSnap.data();
        if (data.started) {
          document.getElementById('mpError').innerText = "Game already started!";
          joinLock = false; return;
        }
        if (data.players && Object.keys(data.players).length >= 5) {
          document.getElementById('mpError').innerText = "Room is full!";
          joinLock = false; return;
        }
        // Check if player with the same name already exists in the room, prevent duplicate join
        let duplicate = Object.values(data.players || {}).some(p => p.name === playerName);
        if (duplicate) {
          document.getElementById('mpError').innerText = "This name already joined!";
          joinLock = false; return;
        }
        localPlayerId = randomCode() + Date.now();
        let leaderboardPatch = data.leaderboard || {};
        leaderboardPatch[localPlayerId] = leaderboardPatch[localPlayerId] || 0;
        await updateDoc(roomRef, {
          [`players.${localPlayerId}`]: {
            name: playerName,
            bar: 0,
            wrongStreak: 0,
            mpQIndex: 0,
            finished: false,
            score: 0
          },
          leaderboard: leaderboardPatch
        });
        joinGameRoom(code, localPlayerId, false);
      } finally {
        setTimeout(() => { joinLock = false; }, 1500); // Slow join (prevent spam)
      }
    };

    // --- ROOM LOGIC ---
    function joinGameRoom(code, playerId, isHost) {
      gameCode = code;
      localPlayerId = playerId;
      playAgainClicked = false;
      kickedFlag = false;
      show('roomMenu');
      document.getElementById('roomCodeShow').innerText = "Room Code: " + code;
      document.getElementById('roomHostShow').innerText = isHost ? "(You are host)" : "";
      renderRoomPlayers([]);
      setupLobbyChat(code);
      if (gameRoomUnsub) gameRoomUnsub();
      const roomRef = doc(db, "climb_games", code);
      gameRoomUnsub = onSnapshot(roomRef, (snap) => {
        if (!snap.exists()) {
          alert("Room closed or deleted!");
          show('mainMenu');
          return;
        }
        gameRoomData = snap.data();
        leaderboard = gameRoomData.leaderboard || {};
        // Check if we've been kicked
        if (!gameRoomData.players[localPlayerId] && !kickedFlag && !gameRoomData.started) {
          kickedFlag = true;
          alert("You have been kicked from the room.");
          show('mainMenu');
          return;
        }
        renderRoomPlayers(gameRoomData.players || {});
        if (gameRoomData.started) {
          show('gamePlay');
          if (lobbyChatUnsub) lobbyChatUnsub();
          startGamePlay();
          setupChat(gameCode);
        }
      });
    }

    function renderRoomPlayers(players) {
      const zone = document.getElementById('roomPlayers');
      if (!players || Object.keys(players).length === 0) {
        zone.innerHTML = "<i>No players yet.</i>";
        document.getElementById('roomStartBtn').disabled = true;
        return;
      }
      let html = "";
      let readyCount = 0;
      Object.entries(players).forEach(([pid, p]) => {
        let kickBtn = "";
        if (gameRoomData && localPlayerId === gameRoomData.host && pid !== localPlayerId) {
          kickBtn = `<button style="margin-left:8px;background:#b00;" onclick="window.kickPlayer('${pid}')" title="Kick">Kick</button>`;
        }
        html += `<div class="room-player${p.ready ? ' ready' : ''}">${p.name} ${p.ready ? "‚úî" : ""}${kickBtn}</div>`;
        if (p.ready) readyCount++;
      });
      zone.innerHTML = html;
      if (gameRoomData && localPlayerId === gameRoomData.host) {
        document.getElementById('roomStartBtn').disabled = readyCount < 2;
      }
    }

    window.kickPlayer = async function(pid) {
      if (!confirm("Kick this player?")) return;
      const roomRef = doc(db, "climb_games", gameCode);
      let patch = {};
      patch[`players.${pid}`] = deleteField();
      await updateDoc(roomRef, patch);
    };

    window.setReady = async function() {
      const roomRef = doc(db, "climb_games", gameCode);
      await updateDoc(roomRef, {
        [`players.${localPlayerId}.ready`]: true
      });
    };

    window.startGameRoom = async function() {
      const roomRef = doc(db, "climb_games", gameCode);
      await updateDoc(roomRef, {
        started: true
      });
    };

    window.leaveRoom = function() {
      if (gameRoomUnsub) gameRoomUnsub();
      if (lobbyChatUnsub) lobbyChatUnsub();
      // Remove self from players in room
      if (gameCode && localPlayerId) {
        const roomRef = doc(db, "climb_games", gameCode);
        let patch = {};
        patch[`players.${localPlayerId}`] = deleteField();
        updateDoc(roomRef, patch);
      }
      show('mainMenu');
    };

    // --- GAMEPLAY ---
    function startGamePlay() {
      endTime = gameRoomData.endTime || (Date.now() + 5 * 60 * 1000);
      gameEnded = false;
      playAgainClicked = false;
      lastBarSnapshot = {};
      setupGlobalTimer();
      renderBars();
      renderGameScreen();
      renderLeaderboardBar();
    }

    // --- TIMER ---
    function setupGlobalTimer() {
      clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    function updateTimer() {
      const now = Date.now();
      let secs = Math.max(0, Math.floor((endTime-now)/1000));
      const min = String(Math.floor(secs/60)).padStart(2,"0");
      const s = String(secs%60).padStart(2,"0");
      document.getElementById('globalTimer').innerText = `${min}:${s}`;
      if (secs <= 0 && !gameEnded) {
        gameEnded = true;
        showResults("Time's up! Here are the scores:");
      }
    }

    // --- BAR DRAW (only refresh if bar actually changes) ---
    function renderBars() {
      const players = gameRoomData.players;
      let barVals = {};
      Object.entries(players).forEach(([pid, p]) => {
        barVals[pid] = p.bar || 0;
      });
      // Only redraw if bars actually changed
      let changed = false;
      for (let pid in barVals) {
        if (lastBarSnapshot[pid] !== barVals[pid]) { changed = true; break; }
      }
      if (!changed) return;
      lastBarSnapshot = {...barVals};
      let barsHtml = "";
      Object.entries(players).sort((a,b) => (b[1].bar||0)-(a[1].bar||0)).forEach(([pid, p]) => {
        let width = Math.round((p.bar/barMax)*100);
        let color = pid === localPlayerId ? "#FFD700" : "#2196f3";
        barsHtml += `
          <div class="player-bar">
            <div class="bar-label">${p.name}</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${width}%;background:${color}"></div>
            </div>
          </div>
        `;
      });
      document.getElementById('barsZone').innerHTML = barsHtml;
    }

    // --- GAME CENTER / QUESTIONS ---
    function renderGameScreen() {
      const player = gameRoomData.players[localPlayerId];
      let mpQIndex = player.mpQIndex || 0;
      let q = gameRoomData.questions[mpQIndex];
      if (!q) {
        showResults();
        return;
      }
      let questionHtml = `
        <div class="question-title">Q${mpQIndex+1}: ${q.question}</div>
        <div class="options">
          ${q.options.map((opt, i) =>
            `<button class="option-btn" onclick="window.answerMp(${i})">${opt}</button>`
          ).join('')}
        </div>
        <div class="flag-progress">
          <div class="flag-img"></div>
          <div class="hill"></div>
        </div>
      `;
      document.getElementById('gameCenter').innerHTML = questionHtml;
    }

    function showResults(msg = "Game Over!") {
      clearInterval(timerInterval);
      gameEnded = true;
      renderLeaderboardBar();
      let winnerId = null;
      if (gameRoomData.winner) {
        let nameToId = Object.entries(gameRoomData.players).find(([pid, p]) => p.name === gameRoomData.winner);
        if (nameToId) winnerId = nameToId[0];
      } else {
        let arr = Object.entries(gameRoomData.players).sort((a, b) => (b[1].bar||0)-(a[1].bar||0));
        winnerId = arr[0][0];
      }
      let players = gameRoomData.players;
      let html = `<div class="flag-trophy"></div>
        <h2>${msg}</h2>
        ${winnerId ? `<div style="color:#FFD700;font-size:1.3em;font-weight:bold;">Winner: ${players[winnerId].name}</div>` : ""}
        <div class="leaderboard">${renderLeaderboard(players)}</div>
        <div id="playAgainZone"></div>`;
      document.getElementById('gameCenter').innerHTML = html;
      setupPlayAgainButton(winnerId);
    }

    function renderLeaderboard(players) {
      let arr = Object.values(players).sort((a,b) => (b.bar||0)-(a.bar||0));
      return arr.map(p => `<div>${p.name}: <b>${p.bar} / ${barMax}</b></div>`).join('');
    }

    function renderLeaderboardBar() {
      let playerMap = gameRoomData.players;
      let leaderboardObj = gameRoomData.leaderboard || {};
      let arr = Object.entries(leaderboardObj)
        .map(([pid, wins]) => ({
          name: playerMap[pid]?.name || "Player",
          wins: wins
        }))
        .sort((a, b) => b.wins - a.wins);
      let html = arr.map(p => `<span style="color:#FFD700;font-weight:bold;">${p.name}: ${p.wins}üèÜ</span>`).join(' &nbsp;|&nbsp; ');
      document.getElementById('leaderboardBar').innerHTML = html || "";
    }

    // --- PLAY AGAIN LOGIC ---
    function setupPlayAgainButton(winnerId) {
      let playAgainArr = gameRoomData.playAgain || [];
      let totalPlayers = Object.keys(gameRoomData.players).length;
      let alreadyClicked = playAgainArr.includes(localPlayerId);
      let btnText = alreadyClicked ? `Waiting (${playAgainArr.length}/${totalPlayers})` : `Play Again (${playAgainArr.length}/${totalPlayers})`;
      let disableBtn = alreadyClicked;
      let btnHtml = `
      <button onclick="window.playAgainClick()" ${disableBtn ? "disabled" : ""}>${btnText}</button>
      `;
      document.getElementById('playAgainZone').innerHTML = btnHtml;
      if (playAgainArr.length === totalPlayers) {
        setTimeout(() => restartGame(winnerId), 1000);
      }
    }

    window.playAgainClick = async function() {
      if (playAgainClicked) return;
      playAgainClicked = true;
      const roomRef = doc(db, "climb_games", gameCode);
      const snap = await getDoc(roomRef);
      let arr = snap.data().playAgain || [];
      if (!arr.includes(localPlayerId)) arr.push(localPlayerId);
      await updateDoc(roomRef, { playAgain: arr });
    };

    // --- GAME RESTART, RESET STUFF, NEW QUESTIONS ---
    async function restartGame(winnerId) {
      if (localPlayerId !== gameRoomData.host) return;
      let leaderboardObj = {...(gameRoomData.leaderboard || {})};
      if (winnerId) leaderboardObj[winnerId] = (leaderboardObj[winnerId] || 0) + 1;
      const colRef = collection(db, "computersystem_questions");
      const snapshot = await getDocs(colRef);
      let questions = [];
      snapshot.forEach(docSnap => {
        const q = docSnap.data();
        questions.push(q);
      });
      questions = chooseQuestions(questions, 30);
      let playersPatch = {};
      Object.entries(gameRoomData.players).forEach(([pid, p]) => {
        playersPatch[pid] = {
          ...p,
          bar: 0,
          wrongStreak: 0,
          mpQIndex: 0,
          finished: false,
          ready: false
        };
      });
      await updateDoc(doc(db, "climb_games", gameCode), {
        questions,
        playAgain: [],
        started: true,
        endTime: Date.now() + 5 * 60 * 1000,
        winner: null,
        leaderboard: leaderboardObj,
        players: playersPatch
      });
    }

    // --- ANSWERING ---
    window.answerMp = async function(idx) {
      if (gameEnded) return;
      let roomRef = doc(db, "climb_games", gameCode);
      let player = gameRoomData.players[localPlayerId];
      let mpQIndex = player.mpQIndex || 0;
      let q = gameRoomData.questions[mpQIndex];
      if (!q) return;
      let correct = idx === q.correctAnswerIndex;
      let updates = {};
      let newBar = player.bar || 0;
      let newWrongStreak = player.wrongStreak || 0;
      let nextQIndex = mpQIndex + 1;
      if (correct) {
        newBar = Math.min(newBar + 1, barMax);
        newWrongStreak = 0;
      } else {
        newWrongStreak += 1;
        if (newWrongStreak >= 2) {
          newBar = Math.max(newBar - 1, 0);
          newWrongStreak = 0;
        }
      }
      updates[`players.${localPlayerId}.bar`] = newBar;
      updates[`players.${localPlayerId}.wrongStreak`] = newWrongStreak;
      updates[`players.${localPlayerId}.mpQIndex`] = nextQIndex;
      let winnerName = null;
      if (correct && newBar >= barMax && !gameRoomData.winner) winnerName = player.name;
      if (winnerName) {
        updates["winner"] = winnerName;
      }
      await updateDoc(roomRef, updates);
      if (correct) renderBars();
      setTimeout(() => {
        if (winnerName || (gameRoomData && gameRoomData.winner)) {
          gameEnded = true;
          showResults("We have a winner!");
        } else {
          gameRoomData.players[localPlayerId].bar = newBar;
          gameRoomData.players[localPlayerId].wrongStreak = newWrongStreak;
          gameRoomData.players[localPlayerId].mpQIndex = nextQIndex;
          renderGameScreen();
        }
      }, 150);
    };

    // --- Live Chat (Firestore) ---
    function setupChat(code) {
      const chatZone = document.getElementById('chatDisplay');
      chatZone.innerHTML = "";
      const chatCol = collection(db, `climb_chat_${code}`);
      const chatQ = query(chatCol, orderBy("ts"));
      if (chatUnsub) chatUnsub();
      chatUnsub = onSnapshot(chatQ, snap => {
        let arr = [];
        snap.forEach(doc => arr.push(doc.data()));
        chatZone.innerHTML = arr.map(msg => `<div class="chat-msg"><b>${msg.name}</b>: ${msg.text}</div>`).join('');
        chatZone.scrollTop = chatZone.scrollHeight;
      });
    }
    window.sendChatMsg = async function() {
      let msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      const chatCol = collection(db, `climb_chat_${gameCode}`);
      await addDoc(chatCol, {
        name: playerName,
        text: msg,
        ts: Date.now()
      });
      document.getElementById('chatInput').value = "";
    };

  </script>
  <style>
    html, body { height:100%; }
    body { margin:0; min-height:100vh; background:#000; }
    .container { max-width:1100px; margin:32px auto; background:rgba(20,18,38,0.93); border-radius:16px; box-shadow:0 4px 24px #001d3d; padding:24px; display:flex; flex-direction:column; align-items:center;}
    .page { display:none; width:100%; min-height:600px; justify-content:center; align-items:center; }
    h1, h2 { text-align:center; color:#FFD700; text-shadow: 0 2px 10px #000;}
    #globalTimer { font-size:2em; color:#FFD700; text-align:center; font-weight:bold; margin-bottom:8px; letter-spacing:2px; }
    .menu-btn, button { background:linear-gradient(90deg,#6D28D9,#3B82F6); color:#fff; border:none; border-radius:8px; padding:14px 32px; cursor:pointer; font-size:20px; margin-bottom:16px; box-shadow:0 2px 8px #0004;}
    .menu-btn:hover, button:hover { background:linear-gradient(90deg,#FFD700,#3B82F6);}
    input[type="text"] { width:100%; padding:10px; border-radius:6px; border:1px solid #b8c9e8; margin-bottom:12px; background:#181732; color:#fff;}
    .room-player { background:#3B82F6; margin-bottom:10px; padding:10px; border-radius:8px; color:#fff; font-weight:bold; box-shadow:0 1px 6px #0003;}
    .room-player.ready { background:#FFD700; color:#333;}
    #roomCodeShow { font-size:1.3em; margin-bottom:12px;}
    #mpError { color:#FFD700; margin-bottom:12px;}
    #roomStartBtn:disabled { opacity:0.5; pointer-events:none;}
    #leaderboardBar { width:100%; background:rgba(30,30,60,0.8); border-radius:10px; margin-bottom:16px; padding:8px 0; text-align:center;}
    /* Game Layout */
    #gamePlay { display:flex; flex-direction:row; gap:24px; min-height:700px; }
    .bars-side { width:200px; background:rgba(40,30,60,0.8); border-radius:16px; padding:18px; min-height:600px; box-shadow:0 2px 16px #0005;}
    .player-bar { margin-bottom:18px; }
    .bar-label { color:#FFD700; font-weight:bold; margin-bottom:2px;}
    .bar-track { background:#222; border-radius:8px; height:24px; width:100%; margin-bottom:2px;}
    .bar-fill { height:24px; border-radius:8px 0 0 8px;}
    .game-center { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;}
    .question-title { font-size:1.3em; color:#fff; margin-bottom:18px; font-weight:bold; text-shadow:0 2px 8px #000;}
    .options { display:flex; flex-direction:column; gap:13px; }
    .option-btn { background:linear-gradient(90deg,#3B82F6,#FFD700); color:#222; font-weight:bold; border:none; border-radius:8px; padding:11px 20px; font-size:18px; box-shadow:0 1px 8px #0005; }
    .option-btn:hover { background:linear-gradient(90deg,#FFD700,#3B82F6); color:#fff;}
    .flag-progress { margin:38px 0 15px 0; position:relative; height:90px; width:260px; }
    .flag-img { position:absolute; left:210px; top:30px; width:48px; height:48px; background:url('https://img.icons8.com/color/96/flag.png') no-repeat center/contain;}
    .hill { position:absolute; left:0; top:50px; width:220px; height:32px; background:linear-gradient(90deg,#1e293b,#3B82F6 60%,#FFD700 100%); border-radius:22px 22px 55px 22px;}
    .flag-trophy { width:100px; height:100px; background:url('https://img.icons8.com/color/96/trophy.png') no-repeat center/contain; margin:0 auto 18px auto;}
    .leaderboard { color:#fff; font-size:1.18em; background:rgba(34,34,54,0.7); border-radius:8px; padding:12px;}
    /* Chat Side */
    .chat-side { width:260px; background:rgba(40,30,60,0.8); border-radius:16px; min-height:600px; box-shadow:0 2px 16px #0005; display:flex; flex-direction:column;}
    .chat-header { color:#FFD700; font-weight:bold; font-size:1.2em; margin-bottom:8px; text-align:center;}
    #chatDisplay, #lobbyChatDisplay { flex:1; overflow-y:auto; max-height:420px; margin-bottom:10px; padding:8px 0;}
    .chat-msg { color:#fff; margin-bottom:7px; }
    #chatInput, #lobbyChatInput { width:88%; margin-right:2%; background:#222; color:#FFD700; border:none; border-radius:8px; padding:8px;}
    /* Responsive */
    @media (max-width:900px) {
      #gamePlay { flex-direction:column; align-items:center;}
      .bars-side, .chat-side { width:90vw; min-height:180px; margin-bottom:18px;}
      .game-center { width:95vw;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="leaderboardBar"></div>
    <!-- MAIN MENU -->
    <div class="page" id="mainMenu" style="flex-direction:column;align-items:center;">
      <h1>Climb The Hill</h1>
      <button class="menu-btn" onclick="window.gotoMultiplayer()">Start Multiplayer</button>
      <div style="margin-top:18px;color:#FFD700;text-shadow:0 1px 8px #000;font-size:1.15em;">
        <b>Answer right to climb, every 2 wrongs lose 1 bar. First to the flag wins, or whoever is ahead after 5 minutes!</b>
      </div>
    </div>
    <!-- MULTIPLAYER LOBBY -->
    <div class="page" id="multiLobby" style="flex-direction:column;">
      <h2>Multiplayer Lobby</h2>
      <input type="text" id="mpName" placeholder="Your name">
      <button onclick="window.createGameRoom()">Create Game Room</button>
      <div style="margin:8px 0;">OR</div>
      <input type="text" id="mpCode" placeholder="Enter game code">
      <button onclick="window.joinGameRoomBtn()">Join Game</button>
      <div id="mpError"></div>
      <button onclick="show('mainMenu')">Back</button>
    </div>
    <!-- ROOM MENU -->
    <div class="page" id="roomMenu" style="flex-direction:column;">
      <h2>Room Lobby</h2>
      <div id="roomCodeShow"></div>
      <div id="roomHostShow"></div>
      <div id="roomPlayers"></div>
      <button id="roomReadyBtn" onclick="window.setReady()">Ready</button>
      <button id="roomStartBtn" onclick="window.startGameRoom()">Start Game</button>
      <button onclick="window.leaveRoom()">Leave</button>
      <div class="chat-side" id="lobbyChatSide">
        <div class="chat-header">Lobby Chat</div>
        <div id="lobbyChatDisplay"></div>
        <div style="display:flex;align-items:center;">
          <input type="text" id="lobbyChatInput" placeholder="Type a message..." onkeydown="if(event.key=='Enter')window.sendLobbyChatMsg();">
          <button onclick="window.sendLobbyChatMsg()" style="padding:8px 18px;">Send</button>
        </div>
      </div>
    </div>
    <!-- GAMEPLAY -->
    <div class="page" id="gamePlay" style="display:flex;flex-direction:row;">
      <div style="position:absolute;top:24px;left:0;right:0;z-index:3;">
        <div id="globalTimer"></div>
      </div>
      <div class="bars-side" id="barsZone"></div>
      <div class="game-center" id="gameCenter"></div>
      <div class="chat-side" id="chatSide">
        <div class="chat-header">Live Chat</div>
        <div id="chatDisplay"></div>
        <div style="display:flex;align-items:center;">
          <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key=='Enter')window.sendChatMsg();">
          <button onclick="window.sendChatMsg()" style="padding:8px 18px;">Send</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>